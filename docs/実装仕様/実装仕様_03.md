````md
# 日次生成「星座占い」実装仕様書（TDD / 運用→見た目）

## 1. スコープ

### 対象
- GitHub Pages + GitHub Actions により配布する静的サイト
- Python による日次生成（`site/` 配下に HTML を生成）
- ベースパス切替（ローカル `/` / Pages `/daily-zodiac/`）

### 非対象
- 外部API（Gemini等）連携の本実装（将来の拡張として設計余地は残す）
- 収益化の実広告貼り付け（今回は枠のみ）
- DB・サーバサイド・ユーザー追跡（PV/クリック以外）

---

## 2. 受け入れ条件（運用 → 見た目）

### A. 運用（先に実装）

#### A1. 日次生成の“正しさ”を CI で検証
- CI（Actions）で `generate.py` 実行後にテストが走ること
- 生成物が当日（JST）の `YYYY-MM-DD` を含むこと（例：`aries/index.html`）
- `site/` に 12星座分のディレクトリ（またはページ）が必ず生成されること
- 入口 `site/index.html` に 12星座へのリンクが存在すること
- `BASE_PATH` に応じてリンクが正しく変化すること
  - ローカル: `/aries/` など
  - Pages: `/daily-zodiac/aries/` など
- 文字化けが起きないこと（`<meta charset="utf-8">` が存在し、日本語（例：牡羊座）が表示できること）

#### A2. 失敗してもサイトは壊れない
- 生成処理が一部失敗しても、フォールバックで 12星座すべて出力されること
- Actions のログ上で、失敗原因が判別できること
  - テスト失敗（仕様違反）
  - 生成失敗（例外）
  - Pagesデプロイ失敗（権限/設定）

#### A3. 実行時刻を README に明記
- cron（UTC）とJST換算を README に明記
- 日付基準が JST であることを README に明記
- ローカル確認手順（PowerShell）を README に明記

---

### B. 見た目（運用が固まった後に実装）

#### B1. 入口ページのUI改善（軽量CSSのみ）
- 星座リンクが 2〜3列のグリッド表示になること
- 入口に “今日の日付（JST）” を表示すること
- スマホ幅では1列になること（レスポンシブ）

#### B2. 結果ページの導線改善
- 「入口へ戻る」に加え「他の星座」リンク群があること
- 見出し構造が整理されていること（`h1` / `h2`）
- 余白・文字サイズが最低限整っていること（外部ライブラリなし）

#### B3. 広告枠は“場所だけ”固定
- 入口：広告枠1つ（固定高さ）
- 結果：広告枠1つ（固定高さ）
- CLS（レイアウトジャンプ）を避けるため、高さは CSS で固定すること
- 実広告コードは入れない（プレースホルダ）

---

## 3. 変更対象ファイル一覧

### 既存変更
- `generate.py`
  - BASE_PATH の反映（既にある前提）
  - 入口/結果ページの HTML に共通CSS（埋め込み or 1ファイル）追加
  - 入口に JST 日付表示追加
  - 結果に「他の星座」導線追加
  - 広告枠プレースホルダ追加
  - UTF-8 meta の確実化

- `.github/workflows/pages.yml`（名称は実際のファイルに合わせる）
  - `generate.py` 実行
  - `pytest` 実行
  - Pages deploy 継続

- `README.md`
  - cron UTC と JST換算
  - JST日付基準
  - ローカル確認コマンド

### 新規追加
- `requirements-dev.txt`（または `requirements.txt` に追記）
  - `pytest`
  - `beautifulsoup4`

- `tests/test_generated_site.py`
  - 生成後のHTML構造テスト一式

- （推奨）`conf_test.py` または `tests/conftest.py`
  - BASE_PATH 切替などの共通fixture

---

## 4. TDD計画（テスト一覧 → 先に書く順）

### 方針
- テストは「生成してから検証」する。
- `generate.py` を subprocess で実行し、`site/` を生成してから BeautifulSoup で検証する。
- BASE_PATH を環境変数で切替し、2パターン（ローカル/Pages）を同一テストで検証する。

### テスト一覧（A→Bの順）

#### A: 運用テスト（最優先で先に書く）
1. `test_generate_creates_12_sign_pages()`
   - `site/{sign}/index.html` が 12個存在する

2. `test_index_has_12_links()`
   - `site/index.html` にリンクが 12個あり、href が星座に対応

3. `test_contains_today_jst_date()`
   - 任意の星座ページ（例：aries）に JST の `YYYY-MM-DD` が含まれる  
   - 【注意】CI実行時刻とJST日付の計算は generate.py と同じ基準で計算する

4. `test_base_path_local_links()`
   - `BASE_PATH=/` で生成した index のリンクが `/aries/` 形式

5. `test_base_path_pages_links()`
   - `BASE_PATH=/daily-zodiac/` で生成した index のリンクが `/daily-zodiac/aries/` 形式

6. `test_utf8_meta_and_japanese_present()`
   - `meta charset="utf-8"` がある
   - `牡羊座` などの日本語がHTMLに含まれる

#### B: 見た目テスト（最低限）
7. `test_index_has_grid_css_hook()`
   - 入口HTMLに `class="sign-grid"` 等のフックが存在

8. `test_pages_have_ad_placeholder()`
   - 入口/結果に `class="ad-slot"` が存在（固定高さはCSS側）

9. `test_result_has_other_signs_nav()`
   - 結果ページに他星座リンク群が存在

---

## 5. 実装手順（最小差分）

### Aフェーズ：運用（先にやる）

#### Step A-1: テスト導入（まず失敗する状態を作る）
1) `requirements-dev.txt` を追加
```txt
pytest
beautifulsoup4
````

2. `tests/test_generated_site.py` を追加（最初はA系テストだけ）

* テスト内で `python generate.py` を実行して `site/` を生成
* 生成先が既にある場合は削除してから生成（テストの独立性確保）

（PowerShell実行想定コマンド）

```powershell
pip install -r requirements-dev.txt
pytest -q
```

#### Step A-2: Actions に pytest を組み込む

* workflow に以下を追加（概略）

  * Python setup
  * `pip install -r requirements.txt`（既存）+ `requirements-dev.txt`
  * `pytest -q`
* テストが落ちたら deploy しない（通常のCIの流れ）

#### Step A-3: generate.py の出力をテストに合わせて固定

* 入口・結果の `<meta charset="utf-8">` を必ず入れる（既に入っているなら維持）
* 入口リンク生成は必ず `BASE_PATH` を使って join する

  * 例：`href = f"{base_path}{sign}/"`（`base_path` の末尾 `/` を正規化）
* 12星座分を必ず生成（例外時は `fallback_one` を使ってでも生成する）
* JST日付は現状のまま（`timezone(timedelta(hours=9))`）

#### Step A-4: README 更新

* cron の意味を明記

  * `10 21 * * *` = UTC 21:10 = JST 06:10
* 生成日付は JST 基準であること
* ローカル確認コマンド

```powershell
$env:BASE_PATH="/"
python .\generate.py
python -m http.server 8000 --directory .\site
# http://localhost:8000/
```

（`cd site` を不要にするため `--directory` を使う）

---

### Bフェーズ：見た目（運用が緑になってから）

#### Step B-1: CSSフックをHTMLに追加

* 入口ページ：

  * `<div class="container">` 等
  * `<ul class="sign-grid">` に変更
* 今日の日付（JST）を入口に表示（例：`<p class="today">2026-02-10 (JST)</p>`）

  * `generate.py` で日付文字列は既に生成しているので再利用

#### Step B-2: 結果ページに導線追加

* ページ下部に「他の星座」リンク（12個）を小さめに配置
* `h1/h2` 構造整理

#### Step B-3: 広告枠プレースホルダ追加

* 入口：`<div class="ad-slot" aria-label="ad-placeholder"></div>`
* 結果：同様
* CSSで固定高さ（例：`min-height: 120px;`）

#### Step B-4: 見た目テストを追加

* B系のテスト 7〜9 を追加してから実装
* テストが通るまで最小修正

---

## 6. 失敗時の切り分け（Actions / ローカル）

### ローカルでの切り分け

1. 生成自体が動くか

```powershell
$env:BASE_PATH="/"
python .\generate.py
```

2. 生成物が揃っているか

```powershell
dir .\site
dir .\site\aries
```

3. ローカルサーブ（cd不要）

```powershell
python -m http.server 8000 --directory .\site
```

4. テスト

```powershell
pip install -r requirements-dev.txt
pytest -q
```

### Actionsでの切り分け

* Actions > workflow run を開いて段階で判定

  1. `generate.py` 実行が失敗 → 生成ログを見る（例外/パス/権限）
  2. `pytest` が失敗 → 期待値と生成物の差分（BASE_PATH/リンク/日付）
  3. `deploy-pages` が失敗 → Pages設定（Settings > Pages）と権限（workflow permissions）

---

## 7. Done の定義（確認チェックリスト）

### A. 運用 Done

* [ ] ローカルで `python generate.py` が成功し `site/` が生成される
* [ ] `pytest -q` がローカルで緑
* [ ] Actions の workflow が緑（push時）
* [ ] cron が意図した時刻（UTC 21:10 = JST 06:10）で回る記述が README にある
* [ ] 入口 `https://nyukimin.github.io/daily-zodiac/` が表示できる
* [ ] 星座ページ `https://nyukimin.github.io/daily-zodiac/aries/` が表示できる
* [ ] 入口のリンクが `/daily-zodiac/aries/` を指す（BASE_PATH反映）
* [ ] 文字化けがない（日本語星座名が表示される）

### B. 見た目 Done

* [ ] 入口がグリッド表示になっている（PCで2〜3列）
* [ ] スマホ幅で1列表示になる
* [ ] 入口に今日の日付（JST）が表示される
* [ ] 結果ページに「他の星座」導線がある
* [ ] 入口・結果に広告枠プレースホルダがある（固定高さでCLSが出にくい）
* [ ] B系テストが緑

```
::contentReference[oaicite:0]{index=0}
```
