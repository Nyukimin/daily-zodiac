````md
# 占いWebアプリ（GitHub Pages + GitHub Actions）実装仕様書 v0.1
最終更新: 2026-02-10（JST）  
担当移譲前提: 本書だけで別エージェントが実装〜公開まで完走できる粒度

---

## 0. ゴール（Doneの定義）

以下を満たしたら完了（MVP）とする。

1) GitHub Pagesで公開されたURLにアクセスできる  
2) `/` に入口ページがあり、12星座へのリンクが並ぶ  
3) `/{sign}/` に各星座の結果ページがあり、**固定フォーマット（要約＋選択肢＋次の一歩）**で表示される  
4) `/{sign}/index.json` が取得でき、HTMLと同内容（同日・同星座で固定）  
5) GitHub Actionsが **毎日1回** 実行され、静的生成物が更新される  
6) 生成処理が失敗しても **サイト公開が壊れない**（最低限のフォールバックが動く）

---

## 1. 方式（アーキテクチャ）

- ホスティング: GitHub Pages（静的配信）
- ビルド/更新: GitHub Actions（Ubuntu runner）
- 生成: Python（`generate.py`）が `site/` 配下へHTML/JSONを出力
- デプロイ: Actionsの `upload-pages-artifact` → `deploy-pages`

重要: Pythonは常時稼働しない（サーバ不要）。日次バッチのみ。

---

## 2. 要件（機能/非機能）

### 2.1 機能要件
- 入力（MVP）: 星座（12星座固定、英語スラッグ）
- 出力: HTML + JSON（同一内容）
- 日付: JST基準で `YYYY-MM-DD`
- 生成対象:
  - `site/index.html`
  - `site/{sign}/index.html`
  - `site/{sign}/index.json`

### 2.2 非機能要件（運用/安全性）
- 同日・同星座は固定（ビルド内で乱数を使わない）
- 外部APIは必須ではない（MVPでは未使用でも可）
- 例外が起きても生成が全体停止しない（星座単位でフォールバック）
- 個人情報の保存/追跡はしない（PV/クリック程度は将来の広告側で）

---

## 3. 固定データ（星座スラッグ）

`SIGNS` は以下固定（順序も固定で良い）

- aries
- taurus
- gemini
- cancer
- leo
- virgo
- libra
- scorpio
- sagittarius
- capricorn
- aquarius
- pisces

---

## 4. 出力フォーマット（固定テンプレ）

### 4.1 JSONスキーマ（必須キー）
- `date`: string（YYYY-MM-DD, JST）
- `sign`: string（上記スラッグ）
- `summary`: string（1〜3文推奨）
- `choices`: array[string]（2〜3個。MVPは3固定で良い）
- `next_step`: string（1つ）

例:
```json
{
  "date": "2026-02-10",
  "sign": "aries",
  "summary": "短い要約…",
  "choices": ["選択肢1", "選択肢2", "選択肢3"],
  "next_step": "次の一歩（1つ）"
}
````

### 4.2 HTML構造（必須セクション）

* H1: `{sign} / {date}`
* summary: `<p>`
* choices: `<ol>` または `<ul>`（2〜3項目）
* next_step: `<p>`

※装飾は最小で良い。CSSは後回し。

---

## 5. フォールバック仕様（必須）

### 5.1 例外の扱い

* 星座単位の生成で例外が起きた場合、その星座は **フォールバックデータ**で出力して継続
* 生成全体が例外で落ちることを避ける（ただし異常終了コードは出してよい/出さないは選択。MVPでは「継続」を優先）

### 5.2 フォールバックデータ生成ルール（MVP）

* `summary`: `{sign} の今日の要約（フォールバック）`
* `choices`: 固定3つ（例: 「整える」「一歩引く」「確認する」）
* `next_step`: 固定（例: 「机の上を1分だけ片付ける」）

※将来、事前に用意した資産から引く方式に差し替える。

---

## 6. リポジトリ構成（必須）

```
/
  generate.py
  requirements.txt            # 依存が無ければ空でもOK
  site/                       # 生成物の出力先（Actionsが作る）
  .github/
    workflows/
      pages.yml
```

* `site/` はコミット不要（生成物）。ただし初期公開のために手元で生成してコミットしてもよい（任意）
* `.github/workflows/pages.yml` は必須

---

## 7. 実装詳細：generate.py

### 7.1 役割

* JSTで当日 `date_str` を求める
* 入口ページ `site/index.html` を生成
* 各星座ディレクトリ `site/{sign}/` を作り、`index.html` と `index.json` を生成

### 7.2 I/O仕様

* 入力: なし（将来設定ファイルを追加可能）
* 出力: `site/` 配下の静的ファイル

### 7.3 関数設計（推奨）

* `get_jst_date_str() -> str`
* `build_one(sign: str, date_str: str) -> dict`

  * 将来、星座資産/天体計算の組み込み箇所
* `fallback_one(sign: str, date_str: str, err: Exception) -> dict`
* `render_html(data: dict) -> str`
* `write_files(sign: str, data: dict, out_root: Path)`

### 7.4 エラー処理（必須）

* 星座ループの中で try/except
* 例外時は `fallback_one()` を使って出力継続

### 7.5 日付（JST）

* `datetime.now(timezone(timedelta(hours=9)))` を使用し `strftime("%Y-%m-%d")`

---

## 8. GitHub Actions：pages.yml

### 8.1 トリガー

* push: main
* schedule: 毎日1回（cronはUTC固定）
* workflow_dispatch: 手動

### 8.2 権限（必須）

* `pages: write`
* `id-token: write`
* `contents: read`

### 8.3 ジョブ構成（必須）

* build:

  * checkout
  * setup-python
  * pip install（requirements.txtがあれば）
  * `python generate.py`
  * upload-pages-artifact（path: site）
* deploy:

  * deploy-pages

### 8.4 スケジュール（重要）

* cronはUTC固定。JSTの朝に回したい場合はUTCへ変換すること。
* ただし生成側はJSTで日付を決めるため、多少ズレても「日付判定」はJSTで行われる。

---

## 9. GitHub Pages 設定手順（実施項目）

リポジトリ設定で以下を実施

1. Settings → Pages
2. Source を **GitHub Actions** に設定

---

## 10. 受け入れテスト（手順）

### 10.1 ローカル（任意だが推奨）

* `python generate.py` を実行
* `site/index.html` が生成される
* `site/aries/index.html` と `site/aries/index.json` が生成される
* JSONの必須キーが揃っている

### 10.2 CI（必須）

* mainにpush
* Actionsが成功（build/deploy）
* Pages URLで以下を確認

  * `/` が表示
  * `/aries/` が表示
  * `/aries/index.json` が取得可能

### 10.3 再現性（必須）

* 同一日に2回workflowを手動実行しても、JSONの `date` と中身が一致する（乱数なし）

---

## 11. 成果物（納品物）

* `generate.py`
* `.github/workflows/pages.yml`
* `requirements.txt`（必要なら）
* README（任意。最低限: デプロイ方法とローカル実行方法）

---

## 12. 実装の最小コード（コピペ用）

### 12.1 generate.py（MVP）

```python
from __future__ import annotations

from dataclasses import dataclass
from datetime import datetime, timezone, timedelta
from pathlib import Path
import json
from typing import Dict, Any, List

JST = timezone(timedelta(hours=9))

SIGNS: List[str] = [
    "aries","taurus","gemini","cancer","leo","virgo",
    "libra","scorpio","sagittarius","capricorn","aquarius","pisces"
]

def get_jst_date_str() -> str:
    return datetime.now(JST).strftime("%Y-%m-%d")

def build_one(sign: str, date_str: str) -> Dict[str, Any]:
    # TODO: ここを「占い資産」や天体計算結果に置換する
    return {
        "date": date_str,
        "sign": sign,
        "summary": f"{sign} の今日の要約（ダミー）",
        "choices": ["少し整える", "一歩引く", "まず確認する"],
        "next_step": "机の上を1分だけ片付ける"
    }

def fallback_one(sign: str, date_str: str, err: Exception) -> Dict[str, Any]:
    return {
        "date": date_str,
        "sign": sign,
        "summary": f"{sign} の今日の要約（フォールバック）",
        "choices": ["少し整える", "一歩引く", "まず確認する"],
        "next_step": "机の上を1分だけ片付ける"
    }

def render_html(data: Dict[str, Any]) -> str:
    choices = data.get("choices", [])
    li = "\n".join([f"  <li>{c}</li>" for c in choices])
    return f"""<h1>{data["sign"]} / {data["date"]}</h1>
<p>{data["summary"]}</p>
<h2>選択肢</h2>
<ol>
{li}
</ol>
<h2>次の一歩</h2>
<p>{data["next_step"]}</p>
"""

def write_sign_files(out_root: Path, sign: str, data: Dict[str, Any]) -> None:
    sign_dir = out_root / sign
    sign_dir.mkdir(parents=True, exist_ok=True)

    (sign_dir / "index.json").write_text(
        json.dumps(data, ensure_ascii=False, indent=2),
        encoding="utf-8"
    )
    (sign_dir / "index.html").write_text(
        render_html(data),
        encoding="utf-8"
    )

def write_index(out_root: Path) -> None:
    links = "\n".join([f'<li><a href="/{s}/">{s}</a></li>' for s in SIGNS])
    html = f"""<h1>今日の星座占い</h1>
<ul>
{links}
</ul>
"""
    (out_root / "index.html").write_text(html, encoding="utf-8")

def main() -> None:
    date_str = get_jst_date_str()
    out_root = Path("site")
    out_root.mkdir(parents=True, exist_ok=True)

    write_index(out_root)

    for sign in SIGNS:
        try:
            data = build_one(sign, date_str)
        except Exception as e:
            data = fallback_one(sign, date_str, e)
        write_sign_files(out_root, sign, data)

if __name__ == "__main__":
    main()
```

### 12.2 .github/workflows/pages.yml（MVP）

```yaml
name: Build & Deploy Pages

on:
  push:
    branches: ["main"]
  schedule:
    # UTC固定（例: JST 06:10 に回したい場合は UTC 21:10）
    - cron: "10 21 * * *"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Generate site
        run: |
          python generate.py

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
```

---

## 13. 追加の注意（移譲先への補足）

* 初回は「ダミー文言」で公開まで通すのが最優先（資産の組み込みは後）
* 乱数を使わないこと（同日・同星座固定のため）
* `site/` はビルド生成物。Gitに入れなくてもPagesは公開できる（Actions経由）
* 生成ロジック差し替え箇所は `build_one()` だけに閉じること（差分を小さくする）

```

必要なら、この仕様書に「広告プレースホルダのHTML位置」「日本語星座名のマッピング」「/YYYY-MM-DD/{sign}/ の日別アーカイブ設計（将来用）」も追加して、さらに他人に投げやすく整えるよ。
::contentReference[oaicite:0]{index=0}
```
