```md
# 日次占い（静的生成 + フォールバック）実装仕様（指示書） v0.2
最終更新: 2026-02-10（JST）  
対象: GitHub Pages + GitHub Actions で公開中の `daily-zodiac`  
目的: 「都度生成」をやめずに、**日次バッチに閉じ込めて保存**し、外部が落ちても必ず返る占いを作る。  
方針: TDD（テストを先に書き、最小実装で通し、段階的に拡張する）

---

## 0. 完了条件（Done）
- `python -m pytest` がローカルで通る
- GitHub Actions が毎日1回回ってデプロイが成功する
- `https://.../daily-zodiac/` から 12星座ページへ遷移できる
- 各星座ページは固定フォーマット（要約＋選択肢2-3＋次の一歩1）
- 外部生成が失敗しても（または未実装でも）**テンプレ資産**で必ず出力される
- 同日・同星座の結果は固定（乱数なし）

---

## 1. アーキテクチャ（採用）
- 静的配信: GitHub Pages（project pages）
- 日次生成: GitHub Actions（Python）
- 生成物: `site/` 配下へ HTML/JSON を出力
- ベースパス: `BASE_PATH`（環境変数）で切替
  - デプロイ: 既定 `"/daily-zodiac/"`
  - ローカル: `BASE_PATH="/"`

---

## 2. ディレクトリ構成（追加）
```

/
generate.py
requirements.txt
assets/
templates.json
site/                   # 生成物（コミット不要）
tests/
test_templates.py
test_determinism.py
test_generate_outputs.py
.github/workflows/pages.yml

````

---

## 3. データ仕様：assets/templates.json（最小）
### 3.1 目的
外部生成が無い/落ちた場合に、日次占いを成立させる“資産”。

### 3.2 形式（JSON）
- ルートは object
- キーは星座スラッグ（12個）
- 値は配列（7〜14個推奨）
- 各要素は object（summary/choices/next_step）
- 乱数は使わず、日付からインデックス決定する

例（抜粋）:
```json
{
  "aries": [
    {
      "summary": "今日は段取りを整えると気持ちが軽くなる日。",
      "choices": ["先に片付ける", "まず見積もる", "誰かに相談する"],
      "next_step": "5分だけ机の上を整える"
    }
  ],
  "taurus": [
    {
      "summary": "小さな手触りの良さが集中を助ける日。",
      "choices": ["道具を整える", "音を減らす", "手順を紙に書く"],
      "next_step": "いちばん使う道具を1つだけ手元に置く"
    }
  ]
}
````

制約:

* `choices` は 2〜3個（MVPは3固定で可）
* 各星座の配列長は **最低1**（推奨7以上）
* 文言は煽らない/断定しない（娯楽）

---

## 4. ロジック仕様（コア）

### 4.1 日付（JST）

* `date_str = YYYY-MM-DD`（JST）
* Python: `datetime.now(JST).strftime("%Y-%m-%d")`

### 4.2 同日固定のインデックス決定（乱数なし）

* `yyyymmdd = int(date_str.replace("-", ""))`
* `idx = yyyymmdd % len(templates[sign])`
* そのテンプレを採用

### 4.3 出力データ（最終）

`build_one()` の返す dict は最低これを持つ:

* `date`, `sign`, `sign_ja`, `summary`, `choices`, `next_step`

---

## 5. 生成フロー（段階導入）

### Phase 1（必須・今やる）

* templates.json から日次結果を作る（外部生成なしで成立）

### Phase 2（任意・後で）

* 外部生成（Gemini等）を追加し、成功時のみ上書き
* 失敗時は Phase 1 のテンプレにフォールバック

### Phase 3（任意・後で）

* アーカイブ保存（`site/archive/YYYY-MM-DD/{sign}.json`）を追加

---

## 6. TDD 指示（テスト→実装の順）

### 6.1 テスト1: templates.json が妥当である（先に書く）

ファイル: `tests/test_templates.py`

期待:

* `assets/templates.json` が存在する
* 12星座キーが揃っている
* 各星座の配列長が1以上
* 各テンプレに `summary/choices/next_step` があり、choicesが2〜3

### 6.2 テスト2: 同日・同星座の決定性（先に書く）

ファイル: `tests/test_determinism.py`

期待:

* `select_template(sign, date_str)` が同じ入力で同じ結果を返す
* 別日（date_str違い）では、同一星座でも別テンプレになり得る（配列長>1の場合）

### 6.3 テスト3: 生成物が揃う（先に書く）

ファイル: `tests/test_generate_outputs.py`

期待:

* `generate_site(date_str=固定)` を実行すると

  * `site/index.html`
  * `site/{sign}/index.html`
  * `site/{sign}/index.json`
    が生成される
* JSON の必須キーが揃っている
* HTML に `<meta charset="utf-8">` と `<base href="...">` が含まれる

---

## 7. 実装タスク（テストが通る最小実装）

### 7.1 generate.py を関数分割（テスト可能に）

必須関数（推奨シグネチャ）:

* `load_templates(path: str|Path) -> dict`
* `select_template(templates: dict, sign: str, date_str: str) -> dict`
* `build_one_from_templates(...) -> dict`
* `generate_site(date_str: str|None = None, out_dir: str|Path = "site") -> None`

注意:

* `if __name__ == "__main__": generate_site()` を維持

### 7.2 requirements.txt

* `pytest` を入れる（ローカル実行用）
* Actionsでテストを回す場合も `pytest` 必須

例:

```
pytest>=8.0.0
```

---

## 8. GitHub Actions への組み込み（任意だが推奨）

`pages.yml` の build ジョブで、生成前に `pytest` を走らせる。

追加ステップ（推奨）:

```yaml
      - name: Run tests
        run: |
          pytest -q
```

方針:

* テストが落ちたらデプロイしない（壊れた占いを公開しない）

---

## 9. ローカル実行（開発ループ）

### 9.1 生成 & プレビュー

```powershell
$env:BASE_PATH="/"
python .\generate.py
python -m http.server 8000 --directory .\site
```

### 9.2 テスト

```powershell
pytest -q
```

---

## 10. 実装上の注意（運用で壊れないため）

* 乱数禁止（再現性）
* 例外は星座単位で吸収し、最低限のフォールバックを返す
* HTMLには必ず UTF-8 宣言
* `<base href>` によりベースパス差を吸収
* 外部生成は「成功時のみ上書き」かつ「失敗してもテンプレで継続」

---

## 11. 受け入れチェック（手動）

* ローカル:

  * `/` 入口で日本語星座名が表示される
  * `/aries/` が表示され、文字化けしない
* 本番:

  * `https://nyukimin.github.io/daily-zodiac/` から遷移できる
  * `.../daily-zodiac/aries/` が404にならない
  * JSONが取得できる（`.../daily-zodiac/aries/index.json`）

---

## 12. 実装順序（指示）

1. `assets/templates.json` を作る（12星座×最低1）
2. `tests/test_templates.py` → 失敗を確認
3. `load_templates()` 実装 → テスト通す
4. `tests/test_determinism.py` → 失敗を確認
5. `select_template()` 実装 → テスト通す
6. `tests/test_generate_outputs.py` → 失敗を確認
7. `generate_site()` 実装 → テスト通す
8. Actions に `pytest` を追加（任意だが推奨）
9. デプロイ確認

```

必要なら、この指示書どおりに **tests/3本の具体コード（pytest）**も、そのままコピペできる形で出す。
::contentReference[oaicite:0]{index=0}
```
